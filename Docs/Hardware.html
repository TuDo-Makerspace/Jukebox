<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jukebox Hardware Documentation</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --sidebar-width: 250px;
            --gap: 30px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            background-color: var(--primary);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar h1 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary);
        }

        .sidebar nav ul {
            list-style: none;
        }

        .sidebar nav li {
            margin-bottom: 10px;
        }

        .sidebar nav a {
            color: white;
            text-decoration: none;
            display: block;
            padding: 8px 10px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .sidebar nav a:hover {
            background-color: var(--secondary);
        }

        /* Main Content */
        .main-content {
            padding: 40px var(--gap);
            max-width: 800px;
        }

        h2 {
            color: var(--primary);
            margin: 30px 0 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--secondary);
        }

        img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            display: block;
            margin: 15px auto;
        }

        .note {
            background-color: #f8f9fa;
            border-left: 4px solid var(--secondary);
            padding: 12px 15px;
            margin: 15px 0;
            border-radius: 0 4px 4px 0;
        }

        ol,
        ul {
            padding-left: 20px;
            margin: 10px 0;
        }

        li {
            margin-bottom: 8px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
                height: auto;
                width: 100%;
            }

            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <aside class="sidebar">
        <h1>Jukebox Hardware Docs</h1>
        <nav>
            <ul>
                <li><a href="#jukebox">Jukebox</a></li>
                <li><a href="#modifications">Modifications</a></li>
                <li><a href="#power">Power</a></li>
                <li><a href="#components">Components</a></li>
                <li><a href="#raspberry-pi">Raspberry Pi</a></li>
                <li><a href="#lamp-driver">Lamp Driver</a></li>
                <li><a href="#keypad">Keypad</a></li>
                <li><a href="#dsp-board">DSP Board</a></li>
                <li><a href="#amplifier-boards">Amplifier Boards</a></li>
                <li><a href="#speakers">Speakers</a></li>
            </ul>
        </nav>
        <a href="./Jukebox.png" target="_blank" class="image-container"><img src="./Jukebox.png" alt="Jukebox"
                style="width: 90%; margin-top: 20px; border: 0px;"></a>
    </aside>

    <main class="main-content">

        <!-- Jukebox -->
        <section id="jukebox">
            <h2>Jukebox</h2>
            <p>
                The original jukebox used in our project is an
                <a href="https://www.jukebox-world.de/Forum/Archiv/NSM/NSMSatellite200.htm" target="_blank">
                    NSM Satellite 200
                </a>, likely produced sometime in the late 1980s.
            </p>
            <br>
            <p>
                In this document we will only cover the hardware modifications made for our project.
                For detailed information on the jukebox's original hardware and specifications, please consult
                the following resources:
            </p>
            <ul>
                <li>
                    <a href="https://www.jukebox-world.de/Forum/Archiv/NSM/NSMSatellite200.htm" target="_blank">
                        NSM Satellite 200 on Jukebox-World.de
                    </a>
                </li>
                <li>
                    <a href="https://propstoreauction.com/lot-details/index/catalog/359/lot/119259" target="_blank">
                        NSM Satellite 200 at Propstore Auction
                    </a>
                </li>
                <li>
                    <a href="https://www.jukebox-world.de/Forum/Archiv/NSM/NSM-Bilder-Uebersicht.htm" target="_blank">
                        NSM Jukebox Image Archive on Jukebox-World.de
                    </a>
                </li>
            </ul>
        </section>

        <!-- Modifications -->
        <section id="modifications">
            <h2>Modifications</h2>
            <p>
                Most original components of the jukebox were removed and replaced with modern hardware.
                The primary modifications include:
            </p>
            <ul>
                <li>
                    <b>Logic and Playback:</b> The primary logic and audio playback are now managed by a Raspberry Pi 3
                    (Model B).
                </li>
                <li>
                    <b>Speakers:</b> Some of the speakers have been replaced with new ones.
                </li>
                <li>
                    <b>Audio Processing and Amplification:</b> Audio output is managed by a
                    <a href="https://store.sure-electronics.com/product/AA-AP23122" target="_blank">
                        WONDOM APM2 DSP Board
                    </a> in combination with two TPA3116D2 amplifier boards.
                </li>
                <li>
                    <b>Volume Control:</b> The volume adjustment buttons located at the back of the jukebox are directly
                    wired to the DSP board.
                </li>
                <li>
                    <b>Lighting:</b> The original lighting controller was replaced by a custom lamp driver board which
                    can
                    be driven directly from the Raspberry Pi.
                </li>
                <li>
                    <b>Keypad Interface:</b> A custom keypad decoder circuit was developed, allowing the Raspberry Pi to
                    interpret user input from the original jukebox keypad.
                </li>
            </ul>
        </section>

        <!-- Power -->
        <section id="power">
            <h2>Power</h2>
            <p>
                The jukebox utilizes two 12V power supplies and two 5V USB adapters to power its components:
            </p>
            <ul>
                <li>
                    <b>Audio Components:</b> One low-noise 12V 5A power supply provides clean and stable power
                    specifically for audio components.
                </li>
                <li>
                    <b>Lamps:</b> A separate 12V 8.5A power supply independently powers the lamps.
                </li>
                <li>
                    <b>RPi and DSP Board:</b> Two dedicated 5V USB adapters supply power to the Raspberry Pi and the DSP
                    board.
                </li>
            </ul>
            <p>
                All power supplies are connected to single power strip.
            </p>
        </section>

        <!-- Components -->
        <section id="components">
            <h2>Components</h2>
            <p>
                The following picture highlights all the components built into the jukebox:
            </p>
            <a href="./HardwarePhoto.png" target="_blank" class="image-container"><img src="./HardwarePhoto.png"
                    alt="Picture of Hardware" /></a>
            <p>Hereâ€™s the respective block diagram:</p>
            <a href="./Block.png" target="_blank" class="image-container"><img src="./Block.png"
                    alt="Block Diagram" /></a>
        </section>

        <!-- Raspberry Pi -->
        <section id="raspberry-pi">
            <h2>Raspberry Pi</h2>
            <p>
                The Raspberry Pi serves as the primary control unit for the jukebox,
                managing all logical operations and handling song playback.
                Detailed information about the software running on the Pi can be found in the
                <a href="https://tudo-makerspace.github.io/Jukebox/Docs/Software.html" target="_blank">
                    software documentation
                </a>.
            </p>
            <br>
            <p>
                To interface with other components, a custom perfboard has been created, which plugs directly into
                the Raspberry Pi's GPIO pins. This perfboard provides connections to the lamp driver. It also
                contains the keypad decoder circuit (refer to the Keypad section for more details) along with a
                connection to the Keypad PCB itself.
            </p>
            <a href="./Perf.png" target="_blank" class="image-container"><img src="./Perf.png" alt="Perfboard" /></a>
            </p>
            <br>
            <p>
                Audio output from the Raspberry Pi is routed via its built-in 3.5mm audio jack, which connects directly
                to the DSP board. Initially, an attempt was made to utilize the IÂ²S interface for improved audio
                fidelity; however, due to reliability issues arising from the Raspberry Pi's lack of a dedicated master
                clock, this approach was abandoned. Consequently, the perfboard contains several unused wires that were
                intended for IÂ²S connections.
            </p>
            <br>
            <p>
                Power to the Raspberry Pi is supplied by a dedicated 5V USB adapter through its micro USB port.
            </p>
        </section>

        <!-- Lamp Driver -->
        <section id="lamp-driver">
            <h2>Lamp Driver</h2>
            <p>
                The jukebox uses
                <a href="https://www.amazon.de/dp/B0CBKYPM57?ref_=ppx_hzsearch_conn_dt_b_fed_asin_title_1"
                    target="_blank">
                    standard 12V T10 lamps
                </a>
                distributed across three independently controllable segments:
            </p>
            <ul>
                <li>Top</li>
                <li>Left & Right (wired together)</li>
                <li>Bottom</li>
            </ul>
            <p>
                To control these segments, a custom lamp driver board was designed to convert the Raspberry Piâ€™s 3.3V
                GPIO outputs to 12V control signals. The KiCAD design files are available
                <a href="https://github.com/TuDo-Makerspace/Jukebox/tree/main/Lamps" target="_blank">here</a>.
            </p>
            <a href="./LampDriverSchem.png" target="_blank" class="image-container"><img src="./LampDriverSchem.png"
                    alt="Lamp Driver Schematic" /></a>
            <a href="./LampDriverPCB3D.png" target="_blank" class="image-container"><img src="./LampDriverPCB3D.png"
                    alt="Lamp Driver PCB 3D" /></a>
            <p>
                The lamp driver receives 12V power from the lighting power supply and connects to the Raspberry Pi via
                a 4-pin JST connector carrying <code>GND</code>, <code>Top</code>, <code>L/R</code>, and
                <code>Bottom</code>
                signals. Lamp outputs are routed through a 6-pin Molex connector, with each segment receiving a
                dedicated <code>+</code> and <code>-</code> connection. When all lamps are active, the board can draw
                up to 6A at 12V, with the <code>L/R</code> segment being the most power-hungry (up to 3A).
            </p>
            <br>
            <p>
                Signal amplification is handled in two stages:
            </p>
            <ol>
                <li>
                    The 3.3V GPIO signal is boosted to 12V using a BSS138 N-channel MOSFET.
                </li>
                <li>
                    This 12V signal is then used to switch a P-channel power MOSFET that controls the lamp segment.
                </li>
            </ol>
            <br>
            <p>
                In the current hardware revision, <strong>TSM7P06CP</strong> P-MOSFETs are used instead of the
                <strong>FDD4141</strong> parts shown in the schematic. Unfortunately, the TSM7P06CP has a significantly
                higher R<sub>DS(on)</sub>, which leads to heat buildup under load. Thermal testing has shown
                temperatures
                reaching up to 60Â°C with the current heatsink. While this remains within safe operating limits, we added
                a layer of Kapton tape between the heatsink and the wooden enclosure as a precaution.
            </p>
            <br>
            <div class="note">
                <p>
                    <strong>Recommendation:</strong> For improved thermal performance, we suggest replacing the
                    TSM7P06CP
                    MOSFETs with FDD4141s in a future revision. This can be done either by building a new PCB or
                    replacing the components on the current board.
                </p>
            </div>
        </section>

        <!-- Keypad -->
        <section id="keypad">
            <h2>Keypad</h2>
            <p>
                The jukebox features two keypads:
            </p>
            <ul>
                <li><strong>Primary keypad:</strong> Contains digits <code>0â€“9</code>, as well as an <code>R</code>
                    and <code>G</code> key.</li>
                <li><strong>Secondary keypad:</strong> Includes three buttons marked with a <strong>yellow</strong>,
                    <strong>blue</strong>, and <strong>red</strong> dot.
                </li>
            </ul>
            <p>
                The secondary keypad is physically connected to the primary keypad via a ribbon cable. Electrically,
                it functions as an extension of the primary keypad, and both share the same decoding logic.
            </p>
            <a href="./Keypad.jpg" target="_blank" class="image-container"><img src="./Keypad.jpg" alt="Keypad" /></a>
            <br>
            <p>
                The reverse-engineered schematic of the keypad, along with the keypad decoder that ensures Raspberry
                Piâ€“compatible logic levels, is shown below:
            </p>
            <a href="./KeypadSch.png" target="_blank" class="image-container"><img src="./KeypadSch.png"
                    alt="Keypad Schematic" /></a>

            <p>
                While the keypad circuit is somewhat quirky, it boils down to providing four digital outputs whose
                states depend on which key is pressed. As long as only one key is pressed at a time, each key
                results in a unique combination of the four output lines.
            </p>
            <br>
            <p>
                The table below summarizes the output patterns and their corresponding keys:
            </p>
            <table style="margin: 15px 0; border-collapse: collapse; width: 100%;">
                <thead>
                    <tr style="border-bottom: 2px solid var(--secondary); text-align: left;">
                        <th style="padding: 8px;">Output Pattern (GPIO 14, GPIO 15, GPIO 23, GPIO 24)</th>
                        <th style="padding: 8px;">Key</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 8px;">(0, 1, 0, 1)</td>
                        <td style="padding: 8px;">0</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">(1, 0, 1, 1)</td>
                        <td style="padding: 8px;">1</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">(1, 0, 0, 1)</td>
                        <td style="padding: 8px;">2</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">(1, 0, 1, 0)</td>
                        <td style="padding: 8px;">3</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">(0, 0, 1, 1)</td>
                        <td style="padding: 8px;">4</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">(0, 0, 0, 1)</td>
                        <td style="padding: 8px;">5</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">(0, 0, 1, 0)</td>
                        <td style="padding: 8px;">6</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">(1, 1, 1, 1)</td>
                        <td style="padding: 8px;">7</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">(1, 1, 0, 1)</td>
                        <td style="padding: 8px;">8</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">(1, 1, 1, 0)</td>
                        <td style="padding: 8px;">9</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">(0, 1, 1, 1)</td>
                        <td style="padding: 8px;">R</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">(0, 1, 1, 0)</td>
                        <td style="padding: 8px;">G</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">(1, 0, 0, 0)</td>
                        <td style="padding: 8px;">YELLOW</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">(0, 1, 0, 0)</td>
                        <td style="padding: 8px;">BLUE</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">(1, 1, 0, 0)</td>
                        <td style="padding: 8px;">RED</td>
                    </tr>
                </tbody>
            </table>
            <p>
                To better understand how the keypad circuit functions, let's walk through a few examples:
            </p>
            <br>
            <p>
                <strong>Example 1 â€“ Yellow Key:</strong><br>
                Arguably the simplest case. When the yellow key is pressed, current flows through the key, diode
                <code>D401</code>, and resistor <code>R9</code>.
                This causes a voltage drop across <code>R9</code>, which is detected as a HIGH signal on
                <code>GPIO14</code>.
                In this configuration, no other current paths are active, so only <code>GPIO14</code> will register a
                HIGH state.
            <div class="note">
                <p>
                    <b>Note:</b> This example also highlights how the decoder circuit works. It simply contains
                    resistors
                    valued such
                    that the measured voltage drop corresponds to the RPi's logic levels. Zener diodes are added where
                    needed to clamp voltages safelyâ€”mainly as a safeguard if multiple keys are pressed.
                </p>
            </div>
            </p>
            <p>
                <strong>Example 2 â€“ Red Key:</strong><br>
                Pressing the red key causes current to flow through the key, as well as diodes <code>D402</code> and
                <code>D403</code>.
                This results in voltage drops across both <code>R9</code> and <code>R10</code>, leading to HIGH readings
                on <code>GPIO14</code> and <code>GPIO15</code>.
            </p>
            <br>
            <p>
                <strong>Example 3 â€“ Key 3 and Transistor <code>T401</code>:</strong><br>
                With this example we introduce the purpose of the PNP transistors. When no key is pressed, the base of
                PNP transistor <code>T401</code> is pulled high via resistor
                <code>R402</code> (2.2k), keeping the transistor turned off.
                Pressing key 3, however, pulls the base low through the key, <code>D401</code>, and <code>R9</code>,
                which switches <code>T401</code> on.
                This allows current to flow through <code>R6</code> and <code>R8</code>, creating voltage dividers that
                drop the voltage to safe 3.3V levels.
                As a result, both <code>GPIO14</code> (via <code>R9</code>) and <code>GPIO23</code> read HIGH.
            </p>
            <br>
            <p>
                <strong>Example 4 â€“ Dual Transistor Activation:</strong><br>
                When pressing any key from the bottom row of the schematic (keys 4, 1, 7, or R), both PNP transistors
                are activated.
                Their bases are connected via diodes to this row, so pressing any of these keys pulls both transistor
                bases low, switching them on.
                Consequently, for these keys, both <code>GPIO24</code> and <code>GPIO23</code> will always register
                HIGH.
            </p>
        </section>

        <!-- DSP Board -->
        <section id="dsp-board">
            <h2>DSP Board</h2>
            <p>
                The jukeboxâ€™s audio processing is handled by a
                <a href="https://store.sure-electronics.com/product/AA-AP23122" target="_blank">
                    WONDOM APM2 DSP Board
                </a>.
            </p>
            <a href="./APM2.png" target="_blank" class="image-container"><img src="./APM2.png"
                    alt="WONDOM APM2 DSP Board" /></a>
            <p>
                The DSP board primarily functions as a 4-way crossover, splitting the incoming audio signal into
                four
                distinct frequency bands:
            </p>
            <ul>
                <li>Low-Low</li>
                <li>Low-Mid</li>
                <li>High-Mid</li>
                <li>High-High</li>
            </ul>
            <br>
            <p>
                The board receives stereo audio input from the Raspberry Piâ€™s 3.5mm jack via its ADC input pins
                (<code>AINL</code>, <code>AINR</code>) and outputs processed audio through four DAC channels
                (<code>DAC0â€“DAC3</code>), which are connected to two separate amplifier boards.
            </p>
            <br>
            <p>
                The volume and clear buttons on the back of the jukebox are directly wired to the GPIO pins of the
                DSP board:
            </p>
            <table style="margin: 15px auto; border-collapse: collapse; width: 80%;">
                <thead>
                    <tr style="border-bottom: 2px solid var(--secondary); text-align: left;">
                        <th style="padding: 8px;">Button</th>
                        <th style="padding: 8px;">GPIO Pin</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 8px;">+</td>
                        <td style="padding: 8px;">GPIO/MP 10</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">-</td>
                        <td style="padding: 8px;">GPIO/MP 11</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">Clear</td>
                        <td style="padding: 8px;">GPIO/MP 6</td>
                    </tr>
                </tbody>
            </table>
            <br>
            <p>
                The DSP configuration is developed and uploaded using
                <a href="https://www.analog.com/en/resources/evaluation-hardware-and-software/embedded-development-software/ss_sigst_02.html"
                    target="_blank">
                    SigmaStudio
                </a>. The corresponding project file is available
                <a href="https://github.com/TuDo-Makerspace/Jukebox/tree/main/Sound/DSP" target="_blank">here</a>.
            </p>
            <a href="./Sigma.png" target="_blank" class="image-container"><img src="./Sigma.png"
                    alt="Sigma Studio" /></a>
            <p>
                A dedicated USB programming board is used to upload the SigmaStudio configuration. It can be found
                inside the jukebox.
            </p>
            <br>
            <p>
                Further documentation and details about the DSP board, as well as how to program it, can be found in
                <a href="https://files.sure-electronics.com/download/The_correspondence_of_APM2_hardware_and_DSP_program.pdf"
                    target="_blank">
                    this manual
                </a>.
                <a href="https://www.youtube.com/watch?v=TjN1SGKeVvw" target="_blank">
                    Video tutorials
                </a> are also available.
            </p>
            <br>
            <h3>Troubleshooting Tips</h3>
            <p>
                Here are some common frustrations we encountered while working with the DSP board:
            </p>
            <ul>
                <li>
                    <strong>USB not recognized (usb device highlighted red):</strong>
                    <ul>
                        <li>Power off the DSP board and unplug the programmer</li>
                        <li>Unplug the programmer's USB cable</li>
                        <li>Replug the programmer's USB cable, check for the device to appear green in SigmaStudio
                        </li>
                        <li>Plug the programmer into the DSP board</li>
                        <li>Power on the DSP board (That being said, it should already be powered on through the
                            programmer at this point)</li>
                    </ul>
                </li>
                <li>
                    <strong>EEPROM programming stuck at &quot;Start Download&quot;:</strong>
                    <ul>
                        <li>Click <em>Link Project</em></li>
                        <li>Click <em>Link Compile Connect</em></li>
                        <li>Click <em>Link Compile Download</em></li>
                        <li>Try flashing the EEPROM again</li>
                    </ul>
                </li>
            </ul>
            <br>
            <h3>Future Plans</h3>
            <p>
                We plan to measure the frequency response of the speakers to implement a tailored equalizer using
                the
                DSP board.
            </p>
        </section>

        <section id="amplifier-boards">
            <h2>Amplifier Boards</h2>
            <p>
                The jukebox uses two
                <a href="https://www.amazon.de/-/en/Lazmin-TPA3116D2-Amplifier-Digital-Channels-standard/dp/B082B31GFX"
                    target="_blank">
                    HW-408 TPA3116D2 amplifier boards
                </a>
                to drive the speakers.
            </p>
            <a href="./TPA3116.jpg" target="_blank" class="image-container"><img src="./TPA3116.jpg"
                    alt="TPA3116D2 Amplifier Board" /></a>
            <p>
                Each board supports an input voltage range of 12V to 26V and features two output channels, each
                capable
                of delivering up to 50W. Gain for each channel can be adjusted using the small trim potentiometers
                on
                the board, however, note that these are very sensitive and should be adjusted with care.
            </p>
            <br>
            <p>
                As already mentioned in the DSP Board section, the DSP outputs four separate audio channels. These
                are
                split evenly between the two amplifier boards, with each board receiving two channels. The amplified
                signals are then routed to the appropriate speakers.
            </p>
        </section>

        <!-- Speakers -->
        <section id="speakers">
            <h2>Speakers</h2>
            <p>
                Some of the original speakers were replaced with new ones. Since we simply used speakers that were
                on
                hand at the Makerspace, their exact specifications were never documented.
            </p>
            <br>
            <p>
                We did, however, need to 3D-print an adapter to accommodate the new mid-range speakers. The 3D model
                is
                available
                <a href="https://github.com/TuDo-Makerspace/Jukebox/tree/main/Sound/Adapter" target="_blank">here</a>.
            </p>
            <a href="./Adapter.png" target="_blank" class="image-container"><img src="./Adapter.png"
                    alt="Speaker Adapter" /></a>
        </section>

    </main>
</body>

</html>