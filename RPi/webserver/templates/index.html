<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jukebox Tracks</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .track-box {
            border: 1px solid #ddd;
            border-radius: 5px;
            height: 150px;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .track-number {
            background-color: #f8f9fa;
            padding: 5px;
            text-align: center;
            font-weight: bold;
            flex: 0 0 auto;
            border-bottom: 1px solid #ddd;
        }

        .track-name {
            padding: 10px;
            text-align: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .track-box.empty {
            background-color: #e0e0e0;
        }

        .track-box:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">Jukebox Tracks</h1>

        <!-- Search Bar -->
        <div class="d-flex justify-content-center mb-4">
            <div class="input-group" style="max-width: 400px;">
                <input type="number" class="form-control" id="trackSearch" placeholder="Enter track number (1-400)"
                    min="1" max="400">
                <button class="btn btn-primary" id="searchButton">Select</button>
            </div>
        </div>

        <!-- Track Grid -->
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
            {% for slot in slots %}
            <div class="col">
                <div class="track-box {% if slot.is_empty %}empty{% else %}uploaded{% endif %}" data-bs-toggle="modal"
                    data-bs-target="#uploadModal" data-track-number="{{ slot.number }}"
                    data-track-name="{{ slot.name }}">
                    <div class="track-number">Track {{ slot.number }}</div>
                    <div class="track-name">
                        {% if not slot.is_empty %}
                        {{ slot.name }}
                        {% else %}
                        Empty Slot
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST" enctype="multipart/form-data" id="uploadForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="uploadModalLabel">Upload Track</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Track Number:</strong> <span id="modalTrackNumber"></span></p>
                        <div id="modalTrackTitleContainer">
                            <p><strong>Track Title:</strong> <span id="modalTrackName"></span></p>
                        </div>
                        <div class="mb-3">
                            <label for="file" class="form-label">Upload MP3 or WAV</label>
                            <input class="form-control" type="file" id="file" name="file" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger" id="errorModalLabel">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="errorModalMessage">
                    <!-- Error message will be dynamically inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
        const errorModalMessage = document.getElementById('errorModalMessage');
        let reopenUploadModal = false; // Track whether the upload modal needs to be reopened

        // Handle search bar functionality
        const searchButton = document.getElementById("searchButton");
        searchButton.addEventListener("click", () => {
            const trackSearch = document.getElementById("trackSearch").value;

            // Validate track number
            const trackNumber = parseInt(trackSearch, 10);
            if (isNaN(trackNumber) || trackNumber < 1 || trackNumber > 400) {
                alert("Please enter a valid track number between 1 and 400.");
                return;
            }

            // Trigger the modal for the searched track
            const targetTrackBox = document.querySelector(`.track-box[data-track-number="${trackNumber}"]`);
            if (targetTrackBox) {
                // Simulate a click to open the modal for the specified track
                targetTrackBox.click();
            } else {
                alert("Track not found!");
            }
        });

        // Handle when upload modal is shown
        uploadModal._element.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const trackNumber = button.getAttribute('data-track-number');
            const trackName = button.getAttribute('data-track-name');
            const isEmpty = button.classList.contains('empty');

            // Update modal content
            document.getElementById('modalTrackNumber').textContent = trackNumber;

            if (!isEmpty) {
                // Show track name for uploaded tracks
                document.getElementById('modalTrackName').textContent = trackName;
                document.getElementById('modalTrackTitleContainer').style.display = 'block';
            } else {
                // Hide track name for empty slots
                document.getElementById('modalTrackTitleContainer').style.display = 'none';
            }

            // Update form action
            const form = document.getElementById('uploadForm');
            form.action = `/upload/${trackNumber}`;
        });

        // Handle form submission
        document.getElementById('uploadForm').addEventListener('submit', async function (event) {
            event.preventDefault(); // Prevent the default form submission

            const formData = new FormData(this);
            const actionUrl = this.action;

            try {
                const response = await fetch(actionUrl, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (response.ok) {
                    // If upload is successful, reload the page
                    location.reload();
                } else {
                    // Hide the upload modal, show the error modal, and set reopen flag
                    uploadModal.hide();
                    errorModalMessage.textContent = result.error || "An unexpected error occurred.";
                    reopenUploadModal = true;
                    errorModal.show();
                }
            } catch (error) {
                // Hide the upload modal, show the error modal, and set reopen flag
                uploadModal.hide();
                errorModalMessage.textContent = "An error occurred while uploading. Please try again.";
                reopenUploadModal = true;
                errorModal.show();
            }
        });

        // Reopen upload modal after closing the error modal
        document.getElementById('errorModal').addEventListener('hidden.bs.modal', function () {
            if (reopenUploadModal) {
                uploadModal.show();
                reopenUploadModal = false; // Reset the flag
            }
        });
    </script>
</body>

</html>